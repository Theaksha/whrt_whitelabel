// pos_selection_dialog.js
function show_pos_selection_dialog() {
    frappe.call({
        method: "frappe.client.get_list",
        args: {
            doctype: "Company",
            fields: ["name"]
        },
        callback: function(response) {
            let companies = response.message;
            if (companies.length === 0) {
                frappe.msgprint("No companies found!");
                return;
            }

            let company_options = companies.map(company => ({
                label: company.name,
                value: company.name
            }));

            let dialog = new frappe.ui.Dialog({
                title: "Select Company and POS Profile",
                fields: [
                    {
                        label: "Company",
                        fieldname: "company",
                        fieldtype: "Select",
                        options: company_options,
                        reqd: 1
                    },
                    {
                        label: "POS Profile",
                        fieldname: "pos_profile",
                        fieldtype: "Select",
                        options: [],
                        reqd: 1
                    }
                ],
                primary_action_label: "Submit",
                primary_action(values) {
                    if (!values.company || !values.pos_profile) {
                        frappe.msgprint("Please select both Company and POS Profile.");
                        return;
                    }

                    // Save selection in localStorage
                    localStorage.setItem("selected_company", values.company);
                    localStorage.setItem("selected_pos_profile", values.pos_profile);

                    company_selected = values.company;
                    pos_profile_selected = values.pos_profile;
                    dialog.hide();
                    frappe.msgprint(`Selected: ${company_selected} - ${pos_profile_selected}`);
                    
                    // Load POS settings
                    load_pos_settings(pos_profile_selected);
                }
            });

            // Fetch POS Profiles when a company is selected
            dialog.fields_dict.company.df.onchange = function() {
                let selected_company = dialog.get_value("company");
                if (selected_company) {
                    frappe.call({
                        method: "whrt_whitelabel.api.get_pos_profiles",
                        args: { company: selected_company },
                        callback: function(response) {
                            let profiles = response.message || [];
                            let profile_options = profiles.map(profile => ({
                                label: profile.name,
                                value: profile.name
                            }));
                            dialog.set_df_property("pos_profile", "options", profile_options);
                        }
                    });
                }
            };

            dialog.show();
        }
    });
}

function load_saved_pos_profile() {
    let saved_company = localStorage.getItem("selected_company");
    let saved_pos_profile = localStorage.getItem("selected_pos_profile");

    if (saved_company && saved_pos_profile) {
        company_selected = saved_company;
        pos_profile_selected = saved_pos_profile;
        frappe.msgprint(`Loaded saved profile: ${company_selected} - ${pos_profile_selected}`);
        load_pos_settings(pos_profile_selected);
    } else {
        show_pos_selection_dialog();
    }
}